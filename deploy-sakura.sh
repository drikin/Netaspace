#!/bin/bash

# ã•ãã‚‰ã®ã‚¯ãƒ©ã‚¦ãƒ‰ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ä½¿ç”¨æ–¹æ³•: ./deploy-sakura.sh

set -e

echo "ğŸš€ ã•ãã‚‰ã®ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™..."

# 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
npm ci --production

# 2. ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
echo "ğŸ”¨ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
npm run build

# 3. PM2ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
if ! command -v pm2 &> /dev/null; then
    echo "ğŸ“¥ PM2ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    sudo npm install -g pm2
fi

# 4. ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
if [ ! -f .env ]; then
    echo "âš ï¸  .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    echo "DATABASE_URLç­‰ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„"
    exit 1
fi

# 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
echo "ğŸ—„ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­..."
npm run db:push

# 6. PM2ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•/å†èµ·å‹•
echo "ğŸ”„ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ä¸­..."
pm2 stop neta-app 2>/dev/null || true
pm2 delete neta-app 2>/dev/null || true
pm2 start dist/index.js --name "neta-app" --max-memory-restart 300M

# 7. PM2ã®è‡ªå‹•èµ·å‹•è¨­å®š
echo "âš™ï¸  PM2ã®è‡ªå‹•èµ·å‹•ã‚’è¨­å®šä¸­..."
pm2 save
pm2 startup

echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"
echo "ğŸ“Š ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹:"
pm2 status
echo ""
echo "ğŸ“ ãƒ­ã‚°ç¢ºèª: pm2 logs neta-app"
echo "ğŸ”„ å†èµ·å‹•: pm2 restart neta-app"
echo "â¹ï¸  åœæ­¢: pm2 stop neta-app"